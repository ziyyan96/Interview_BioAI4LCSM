
---
title: "PAM50 Subtype Analysis Using limma and CNAttention Signature"
output: html_notebook
---

# PAM50 Subtype Analysis Using limma and CNAttention Signature

This notebook provides a complete pipeline to explore subtype-specific gene expression profiles in breast cancer, using the PAM50 classification system. It combines classical differential expression analysis using the `limma` package with interpretation and visualization of custom signatures generated by a deep learning model called **CNAttention**.

The workflow includes:

- Loading and preparing input data
- Differential expression analysis using `limma`
- Extracting and visualizing top marker genes per subtype
- Principal Component Analysis (PCA)
- Heatmap visualization of CNAttention-derived subtype signatures

---

## 1. Load Required R Packages

I begin by loading the necessary libraries. Packages will be automatically installed if missing.

```{r}
if (!requireNamespace("ConsensusClusterPlus", quietly = TRUE)) {
  install.packages("BiocManager")
  BiocManager::install("ConsensusClusterPlus")
}
library(ConsensusClusterPlus)
library(pheatmap)
library(RColorBreIr)
install.packages("umap")

if (!require("DESeq2")) install.packages("BiocManager"); BiocManager::install("DESeq2")
library(DESeq2)
library(dplyr)
library(tibble)

if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("survcomp")
```

---

## 2. Differential Expression Analysis Using limma

I perform a one-vs-rest differential expression test for each PAM50 subtype using the `limma` package. Marker genes are selected based on adjusted p-value and log fold-change cutoffs. The results are saved as CSV files for downstream visualization.

```{r}
df_meta <- read.delim("/Users/ziyyan/Research/GitHub/0718_interview/data/df_meta.tsv", row.names = 1,check.names = FALSE)
expr <- read.delim("/Users/ziyyan/Research/GitHub/0718_interview/data/df_merged.tsv", row.names = 1, check.names = FALSE)
# ==== 1. Load packages ====
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("limma")

library(limma)
library(dplyr)
library(tibble)

# ==== 2. Prepare expression and clinical data ====

df_meta <- df_meta[df_meta$sample_id %in% colnames(expr), ]
expr <- as.matrix(expr)

subtypes <- unique(df_meta$pam50_subtype)

# ==== 3. Perform "One Subtype vs Others" Differential Expression Analysis ====
for (s in subtypes) {
  cat("Processing subtype:", s, "\n")
  
  # Create a binary group: current subtype vs others
  df_meta$group <- ifelse(df_meta$pam50_subtype == s, s, "Other")
  df_meta$group <- factor(df_meta$group)
  
  # Construct the design matrix
  design <- model.matrix(~ 0 + df_meta$group)
  colnames(design) <- levels(df_meta$group)
  
  # Fit the linear model
  fit <- lmFit(expr, design)
  contrast.matrix <- makeContrasts(contrasts = paste0(s, "-Other"), levels = design)
  fit2 <- contrasts.fit(fit, contrast.matrix)
  fit2 <- eBayes(fit2)
  
  # Extract differential expression results
  res <- topTable(fit2, adjust = "fdr", number = Inf)
  
  # Filter significantly up- and down-regulated genes
  res_up   <- res %>% filter(adj.P.Val < 0.05 & logFC > 1)
  res_down <- res %>% filter(adj.P.Val < 0.05 & logFC < -1)
  
  # Save results to CSV files
  s_clean <- gsub(" ", "_", s)
  write.csv(res_up,   paste0("limma_marker_", s_clean, "_up.csv"))
  write.csv(res_down, paste0("limma_marker_", s_clean, "_down.csv"))
  
  # GPT-style prompts for biological interpretation
  top_up <- rownames(res_up)[1:min(10, nrow(res_up))]
  top_down <- rownames(res_down)[1:min(10, nrow(res_down))]

  cat("GPT Prompt (UP):\n")
  cat("In breast cancer, subtype", s, "significantly upregulates the following genes compared to other subtypes:",
      paste(top_up, collapse = ", "), 
      ".\nWhat biological features or pathways might these genes represent?\n\n")
  
  cat("GPT Prompt (DOWN):\n")
  cat("In breast cancer, subtype", s, "significantly downregulates the following genes compared to other subtypes:",
      paste(top_down, collapse = ", "), 
      ".\nWhat biological features or pathways might these genes represent?\n\n")
}
```

---

## 3. Heatmap of Top Marker Genes

I compile the top upregulated and downregulated genes for each subtype (based on `limma`), then visualize the expression of these genes across all samples using a heatmap. This helps identify subtype-specific expression patterns.

```{r}
# === 0. Prepare expression data and clinical metadata ===
# expr: matrix/data.frame, rows = genes, columns = samples
# df_meta: data.frame, must contain 'sample_id' and 'pam50_subtype'

# === 1. Extract top 10 up- and down-regulated genes per subtype ===
subtypes <- unique(df_meta$pam50_subtype)
top_genes_all <- c()
gene2subtype <- c()
gene2direction <- c()

for (s in subtypes) {
  s_clean <- gsub(" ", "_", s)
  
  # Upregulated genes
  up_fname <- paste0("limma_marker_", s_clean, "_up.csv")
  if (file.exists(up_fname)) {
    df_up <- read.csv(up_fname, row.names = 1)
    genes_up <- rownames(df_up)[1:min(5, nrow(df_up))]  # top 5
    top_genes_all <- c(top_genes_all, genes_up)
    gene2subtype <- c(gene2subtype, rep(s, length(genes_up)))
    gene2direction <- c(gene2direction, rep("Up", length(genes_up)))
  }
  
  # Downregulated genes
  down_fname <- paste0("limma_marker_", s_clean, "_down.csv")
  if (file.exists(down_fname)) {
    df_down <- read.csv(down_fname, row.names = 1)
    genes_down <- rownames(df_down)[1:min(10, nrow(df_down))]  # top 10
    top_genes_all <- c(top_genes_all, genes_down)
    gene2subtype <- c(gene2subtype, rep(s, length(genes_down)))
    gene2direction <- c(gene2direction, rep("Down", length(genes_down)))
  }
}

top_genes_all <- unique(top_genes_all)

# === 2. Extract expression matrix (rows: genes, columns: samples) ===
mat <- expr[top_genes_all, , drop = FALSE]

# === 3. Match clinical metadata and reorder samples ===
df_meta <- df_meta[df_meta$sample_id %in% colnames(mat), ]
df_meta <- df_meta[match(colnames(mat), df_meta$sample_id), ]
rownames(df_meta) <- df_meta$sample_id

# Order samples by subtype
df_meta$pam50_subtype <- factor(df_meta$pam50_subtype, levels = subtypes)
df_meta <- df_meta %>% arrange(pam50_subtype)
ordered_samples <- df_meta$sample_id
mat <- mat[, ordered_samples]

# === 4. Construct column annotations (sample-level) ===
anno_col <- data.frame(Subtype = df_meta$pam50_subtype)
rownames(anno_col) <- df_meta$sample_id

# === 5. Construct row annotations (gene-level) ===
anno_row <- data.frame(
  MarkerFor = gene2subtype,
  Direction = gene2direction
)
rownames(anno_row) <- top_genes_all

# === 6. Define color mappings ===
subtype_colors <- setNames(breIr.pal(length(subtypes), "Set2"), subtypes)
ann_colors <- list(
  Subtype = subtype_colors,
  MarkerFor = subtype_colors,
  Direction = c(Up = "firebrick", Down = "dodgerblue")
)

# === 7. Plot heatmap ===
pheatmap(mat,
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         annotation_col = anno_col,
         annotation_row = anno_row,
         annotation_colors = ann_colors,
         fontsize_row = 7,
         fontsize_col = 5,
         show_colnames = FALSE,
         main = "Top 5 Up/Down Marker Genes per PAM50 Subtype")
```

---

## 4. PCA of Marker Genes

To further explore the separation of samples based on marker gene expression, I perform Principal Component Analysis (PCA). This plot provides an unsupervised view of subtype clustering.

```{r}
library(ggplot2)


mat_pca <- t(expr[top_genes_all, ])  


pca <- prcomp(mat_pca, center = TRUE, scale. = FALSE)  


pca_df <- data.frame(
  PC1 = pca$x[, 1],
  PC2 = pca$x[, 2],
  sample_id = rownames(pca$x)
)
pca_df <- merge(pca_df, df_meta, by = "sample_id")


ggplot(pca_df, aes(x = PC1, y = PC2, color = pam50_subtype)) +
  geom_point(size = 2.5, alpha = 0.8) +
  theme_minimal() +
  labs(title = "PCA of Top Marker Genes", x = "PC1", y = "PC2") +
  scale_color_breIr(palette = "Set2") +
  theme(plot.title = element_text(hjust = 0.5))
```

---

## 5. Heatmap of CNAttention Signature Genes

In addition to statistically derived markers, I visualize the gene expression pattern of a machine-learning derived signature from **CNAttention**. Each subtype includes a list of upregulated (`HIGH`) and downregulated (`LOW`) genes. This section displays a heatmap of these custom-defined markers across samples.

```{r}
library(jsonlite)
library(pheatmap)
library(RColorBreIr)
library(dplyr)

# === Step 1: Load signature JSON ===
sig_file <- "/Users/ziyyan/Research/GitHub/0718_interview/signature.json"  # Path to your signature JSON file
signature <- fromJSON(sig_file)

# === Step 2: Build gene list and annotations ===
gene_info <- data.frame(
  Gene = character(),
  MarkerFor = character(),
  Direction = character(),
  stringsAsFactors = FALSE
)

for (s in names(signature)) {
  if (!is.null(signature[[s]]$HIGH)) {
    gene_info <- rbind(
      gene_info,
      data.frame(Gene = signature[[s]]$HIGH, MarkerFor = s, Direction = "Up")
    )
  }
  if (!is.null(signature[[s]]$LOW)) {
    gene_info <- rbind(
      gene_info,
      data.frame(Gene = signature[[s]]$LOW, MarkerFor = s, Direction = "Down")
    )
  }
}

# Remove duplicated genes (keep the first occurrence)
gene_info <- gene_info[!duplicated(gene_info$Gene), ]

# Extract gene list
top_genes_all <- gene_info$Gene

# === Step 3: Subset expression matrix for selected genes ===
mat <- expr[top_genes_all, , drop = FALSE]

# === Step 4: Match and order metadata by sample IDs ===
df_meta <- df_meta[df_meta$sample_id %in% colnames(mat), , drop = FALSE]
df_meta <- df_meta[match(colnames(mat), df_meta$sample_id), , drop = FALSE]
rownames(df_meta) <- df_meta$sample_id

# === Step 5: Order samples by PAM50 subtype ===
subtypes <- names(signature)
df_meta$pam50_subtype <- factor(df_meta$pam50_subtype, levels = subtypes)
df_meta <- df_meta %>% arrange(pam50_subtype)
ordered_samples <- df_meta$sample_id
mat <- mat[, ordered_samples]

# === Step 6: Create column annotations ===
anno_col <- data.frame(Subtype = df_meta$pam50_subtype)
rownames(anno_col) <- df_meta$sample_id

# === Step 7: Create row annotations ===
anno_row <- gene_info[, c("MarkerFor", "Direction")]
rownames(anno_row) <- gene_info$Gene

# === Step 8: Define annotation color schemes ===
subtype_colors <- setNames(breIr.pal(length(subtypes), "Set2"), subtypes)
ann_colors <- list(
  Subtype = subtype_colors,
  MarkerFor = subtype_colors,
  Direction = c(Up = "firebrick", Down = "dodgerblue")
)

# === Step 9: Plot heatmap ===
pheatmap(mat,
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         annotation_col = anno_col,
         annotation_row = anno_row,
         annotation_colors = ann_colors,
         fontsize_row = 7,
         fontsize_col = 5,
         show_colnames = FALSE,
         main = "Signature Marker Genes (From JSON)")
```

---

## Summary

- I applied `limma` to identify statistically significant marker genes for each breast cancer subtype.
- A heatmap and PCA provided insights into sample stratification by expression.
- I visualized a model-derived signature (from CNAttention) and compared its expression pattern across subtypes.

This integrated analysis highlights both statistically and biologically informed gene signatures, aiding in the interpretation of molecular subtypes in breast cancer.

